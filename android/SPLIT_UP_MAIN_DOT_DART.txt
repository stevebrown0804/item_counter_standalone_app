Assumptions (so you can sanity-check):

1. It is acceptable to use Dart `part` / `part of` so all the `_private` types still see each other.
2. We are only *moving* code blocks into a new file, not changing any logic or signatures.
3. `main.dart` is under `lib/` and the new file will live next to it as `lib/backend.dart`.

With that, here is a minimal split that removes the whole backend (FFI + DB + data classes + store) from `main.dart` into `backend.dart`. UI + `main()` stay in `main.dart`, and all `_` names remain private to the same library.

---

## 1. Add a `part` directive in `main.dart`

**Search for this line** (last import):

```dart
import 'package:timezone/data/latest_all.dart' as tzdata;
```

**Immediately after it**, insert:

```dart
part 'backend.dart';
```

So the top of `main.dart` should now look like:

```dart
//REMINDER: Path (Medium Phone API 36.0):
// Full path: /data/data/com.example.daily_pill_counter
// Pastable piece: com.example.daily_pill_counter

// <editor-fold desc="Imports, consts, main, etc.">
import 'dart:async';
import 'dart:collection';
import 'dart:convert';
import 'dart:ffi' as ffi;
import 'dart:io';
import 'package:ffi/ffi.dart' as ffi_helpers;
import 'package:flutter/material.dart';
import 'package:sqflite/sqflite.dart';
import 'package:path/path.dart' as p;
import 'package:media_store_plus/media_store_plus.dart';
import 'package:flutter/services.dart'; // for FilteringTextInputFormatter
import 'package:timezone/timezone.dart' as tz;
import 'package:timezone/data/latest_all.dart' as tzdata;

part 'backend.dart';

/// Filenames / view names must match your existing DB.
const String kDbFileName = 'daily-pill-tracking.db';
...
```

Nothing else at the top needs to change.

---

## 2. Create `lib/backend.dart`

Create a new file next to `main.dart` called `backend.dart`.

At the top of `backend.dart`, put:

```dart
part of 'main.dart';
```

Everything else in this file will be *moved* from `main.dart` as described below.

---

## 3. Move the backend blocks into `backend.dart`

You are going to *cut* four big blocks out of `main.dart` and paste them (in order) under the `part of` line in `backend.dart`.

### 3.1 Rust FFI bridge (`_FfiBackend` and typedefs)

In `main.dart`, **find this comment**:

```dart
// ───────────────────────── Rust FFI bridge ─────────────────────────
```

and **select from that line all the way down through the closing brace of `_FfiBackend`**, which ends just before this comment:

```dart
// ───────────────────────── DB wrapper (sqflite + Rust FFI) ─────────────────────────
```

So the block you cut starts with:

```dart
// ───────────────────────── Rust FFI bridge ─────────────────────────

// Native typedefs
typedef _IcbOpenNative = ...
```

and ends with:

```dart
  Future<List<int>> redoLogicalBatch(String token) async {
    ...
  }
}
```

Paste that entire block directly under `part of 'main.dart';` in `backend.dart`.

---

### 3.2 DB wrapper (`_Db`)

Still in `main.dart`, **find this comment**:

```dart
// ───────────────────────── DB wrapper (sqflite + Rust FFI) ─────────────────────────
```

**Select from that comment down through the end of the `_Db` class**, which ends with:

```dart
  }
} // class _Db

// </editor-fold>
```

Cut that whole block and paste it *after* the FFI block in `backend.dart`.

In `backend.dart` the order should now be:

```dart
part of 'main.dart';

// ───────────────────────── Rust FFI bridge ─────────────────────────
... all typedefs and class _FfiBackend ...

// ───────────────────────── DB wrapper (sqflite + Rust FFI) ─────────────────────────
... class _Db ...
```

---

### 3.3 Data classes and helpers

In `main.dart`, **find this editor-fold**:

```dart
// <editor-fold desc="Data-related classes/fns">
```

and **select from that line down through its matching closing comment**:

```dart
// </editor-fold>
```

That block starts with:

```dart
// <editor-fold desc="Data-related classes/fns">
class _Pill {
  ...
}

...
DateTime parseDbUtc(String s) {
  ...
}

// </editor-fold>
```

Cut that whole block and paste it *after* the `_Db` block in `backend.dart`.

---

### 3.4 Store (`_Store`)

In `main.dart`, **find this editor-fold**:

```dart
// <editor-fold desc="_Store? *shrug*">
```

and **select from that line down through its closing `// </editor-fold>`**.

Block starts with:

```dart
// <editor-fold desc="_Store? *shrug*">
class _Store extends ChangeNotifier {
  ...
}
```

and ends with:

```dart
  }
}

// </editor-fold>
```

Cut that block and paste it *after* the data-classes block in `backend.dart`.

---

## 4. What stays in `main.dart`

After those moves, `main.dart` should still contain:

* Imports and constants + `_TxMode` enum.
* `_pickLocalDateTime` function.
* `_TxRow` class.
* `PillApp` widget.
* All UI widgets (`_SkipSecondConfirmSetting`, `SettingsScreen`, `_WindowRow`, `_TzRow`, `_ViewScreen`, `_ViewScreenState`).
* The `main()` function.

Plus the new:

```dart
part 'backend.dart';
```

All the backend types (`_FfiBackend`, `_Db`, `_Pill`, `_AvgRow`, `_Entry`, `_TxnSnapshot`, `_Tz`, `parseDbUtc`, `_Store`) now live in `backend.dart` but are visible everywhere because they share the same library.

You do **not** need to change any imports, any uses of `_Db`, `_Store`, etc., or any logic.

---

## 5. Quick sanity checklist

After you move the blocks:

* `backend.dart` begins with `part of 'main.dart';` and then contains those four blocks, unchanged.
* `main.dart` has the `part 'backend.dart';` line after the imports and before the constants.
* There are no duplicate definitions: `_FfiBackend`, `_Db`, `_Pill`, `_Store`, etc., should appear only in `backend.dart`.
* UI still compiles and runs, since `_Store` and `_Db` are just in a part file.

If you want to do a second pass later, we can repeat the same pattern to split UI into separate part files (`view_screen.dart`, `settings_screen.dart`) without touching any logic.
