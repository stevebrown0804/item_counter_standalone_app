Filename: daily-pill-tracking.db

DDLs:

CREATE TABLE logical_batch_items (
    id             INTEGER  PRIMARY KEY AUTOINCREMENT,
    batch_id       INTEGER  NOT NULL,
    transaction_id INTEGER  NOT NULL,
    item_id        INTEGER  NOT NULL,
    quantity       INTEGER  NOT NULL,
    timestamp_utc  DATETIME NOT NULL,
    FOREIGN KEY (
        batch_id
    )
    REFERENCES logical_batches (id)
);



CREATE TABLE logical_batches (
    id         INTEGER  PRIMARY KEY AUTOINCREMENT,
    token      TEXT     NOT NULL,
    undone     INTEGER  NOT NULL
                        DEFAULT 0,
    created_at DATETIME NOT NULL
                        DEFAULT CURRENT_TIMESTAMP
);



CREATE TABLE item_transactions (
    id            INTEGER  PRIMARY KEY,
    item_id       INTEGER  NOT NULL,
    quantity      INTEGER  NOT NULL
                           CHECK (quantity > 0),
    timestamp_utc DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (
        item_id
    )
    REFERENCES items (id)
);



CREATE TABLE items (
    id             INTEGER PRIMARY KEY AUTOINCREMENT,
    display_string TEXT    UNIQUE
                           NOT NULL,
    display_order  INTEGER,
    show_item      INTEGER NOT NULL
                           DEFAULT (1)
);



CREATE TABLE settings (
    key   TEXT PRIMARY KEY,
    value TEXT NOT NULL
);

settings table defaults:
avg_window_days	30
skip_delete_transactions_second_dialog_confirmation	0
time_zone_id	0
appbar_title	"Item Counter"
lhs_column_header	"Item"
rhs_column_header	"Avg. ({days} day(s))""



CREATE TABLE time_zone_aliases (
    id           INTEGER PRIMARY KEY,
    alias        TEXT    NOT NULL
                         UNIQUE,
    iana_tz_name TEXT    NOT NULL
);

time_zone_aliases defaults:
1	UTC	Etc/UTC
2	GMT	Etc/UTC
3	Z	Etc/UTC
(The specific id values aren't really important, but the backend will add these 3 aliases in this order, if they're not already there.)


---------------------------------------------------------------------------------------------------
View queries:

CREATE VIEW logged_days AS
WITH cfg AS (
        SELECT CAST ( (
                   SELECT value
                     FROM settings
                    WHERE key = 'avg_window_days'
               )
               AS INTEGER) AS n
    ),
    global AS (
        SELECT DATE('now') AS today,
               MIN(DATE(timestamp_utc) ) AS min_date
          FROM item_transactions
    ),
    window AS (
        SELECT g.today,
               g.min_date,
               c.n,-- N-day inclusive start: today - (n-1) days
               DATE(JULIANDAY(g.today) - (c.n - 1) ) AS n_start,
               CASE
                   WHEN g.min_date IS NULL THEN 0
                   ELSE CAST (JULIANDAY(g.today) - JULIANDAY(MAX(g.min_date, DATE(JULIANDAY(g.today) - (c.n - 1) ) ) ) AS INTEGER) + 1
               END AS days
          FROM global g
               CROSS JOIN
               cfg c
    )
    SELECT days AS number_of_days
      FROM window;

