Timestamp: 2025-11-29 15:32
Filename: daily-pill-tracking.db

DDLs:

CREATE TABLE logical_batch_items (
    id             INTEGER  PRIMARY KEY AUTOINCREMENT,
    batch_id       INTEGER  NOT NULL,
    transaction_id INTEGER  NOT NULL,
    pill_id        INTEGER  NOT NULL,
    quantity       INTEGER  NOT NULL,
    timestamp_utc  DATETIME NOT NULL,
    FOREIGN KEY (
        batch_id
    )
    REFERENCES logical_batches (id)
);

FK reminder: We had an FK on transaction_id but it led to Undo button presses going (mostly) silently ignore.  (...and now it's gone.)


CREATE TABLE logical_batches (
    id         INTEGER  PRIMARY KEY AUTOINCREMENT,
    token      TEXT     NOT NULL,
    undone     INTEGER  NOT NULL
                        DEFAULT 0,
    created_at DATETIME NOT NULL
                        DEFAULT CURRENT_TIMESTAMP
);



CREATE TABLE pill_transactions (
    id            INTEGER  PRIMARY KEY,
    pill_id       INTEGER  NOT NULL,
    quantity      INTEGER  NOT NULL
                           CHECK (quantity > 0),
    timestamp_utc DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (
        pill_id
    )
    REFERENCES pills (id)
);


CREATE TABLE pill_types (
    id   INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT    UNIQUE
                 NOT NULL
);


CREATE TABLE pills (
    id                                INTEGER PRIMARY KEY AUTOINCREMENT,
    name                              TEXT    UNIQUE
                                              NOT NULL,
    type_id                           INTEGER NOT NULL,
    [grams-protein-digestion-potency] REAL,
    display_order                     INTEGER,
    FOREIGN KEY (
        type_id
    )
    REFERENCES pill_types (id)
);


CREATE TABLE settings (
    key   TEXT PRIMARY KEY,
    value TEXT NOT NULL
);

settings table defaults:
avg_window_days	30
skip_delete_transactions_second_dialog_confirmation	0
time_zone_id	0
appbar_title	"Item Counter"
lhs_column_header	"Item"
rhs_column_header	"Avg. ({days} day(s))""


CREATE TABLE time_zones (
    id      INTEGER PRIMARY KEY,
    alias   TEXT    NOT NULL
                    UNIQUE,
    tz_name TEXT    NOT NULL
);


---------------------------------------------------------------------------------------------------
View queries:

CREATE VIEW daily_avg_by_pill_UTC AS
WITH cfg AS (
        SELECT CAST ( (
                   SELECT value
                     FROM settings
                    WHERE key = 'avg_window_days'
               )
               AS INTEGER) AS n
    ),
    global AS (
        SELECT DATE('now') AS today,
               MIN(DATE(timestamp_utc) ) AS min_date
          FROM pill_transactions
    ),
    window AS (
        SELECT g.today,-- Effective start = max(oldest_tx_date, today-(n-1))
               MAX(g.min_date, DATE(JULIANDAY(g.today) - (c.n - 1) ) ) AS start_date,
               CASE WHEN g.min_date IS NULL THEN 0 ELSE CAST (JULIANDAY(g.today) - JULIANDAY(MAX(g.min_date, DATE(JULIANDAY(g.today) - (c.n - 1) ) ) ) AS INTEGER) + 1 END AS days
          FROM global g
               CROSS JOIN
               cfg c
    )
    SELECT p.id AS pill_id,
           p.display_order AS display_order,
           p.name AS pill_name,
           CASE WHEN w.days = 0 THEN 0 ELSE ROUND(1.0 * COALESCE(SUM(CASE WHEN DATE(pt.timestamp_utc) BETWEEN w.start_date AND w.today THEN pt.quantity ELSE 0 END), 0) / w.days, 2) END AS daily_avg
      FROM pills p
           CROSS JOIN
           window w
           LEFT JOIN
           pill_transactions pt ON pt.pill_id = p.id
     GROUP BY p.id,
              p.display_order,
              p.name,
              w.days
     ORDER BY p.display_order,
              p.id;



CREATE VIEW logged_days AS
WITH cfg AS (
        SELECT CAST ( (
                   SELECT value
                     FROM settings
                    WHERE key = 'avg_window_days'
               )
               AS INTEGER) AS n
    ),
    global AS (
        SELECT DATE('now') AS today,
               MIN(DATE(timestamp_utc) ) AS min_date
          FROM pill_transactions
    ),
    window AS (
        SELECT g.today,
               g.min_date,
               c.n,-- N-day inclusive start: today - (n-1) days
               DATE(JULIANDAY(g.today) - (c.n - 1) ) AS n_start,
               CASE WHEN g.min_date IS NULL THEN 0 ELSE CAST (JULIANDAY(g.today) - JULIANDAY(MAX(g.min_date, DATE(JULIANDAY(g.today) - (c.n - 1) ) ) ) AS INTEGER) + 1 END AS days
          FROM global g
               CROSS JOIN
               cfg c
    )
    SELECT days AS number_of_days
      FROM window;



CREATE VIEW [Transactions_(Mtn Time)] AS
    SELECT datetime(pt.timestamp_utc, '-6 hours') AS local_timestamp,
           pt.pill_id,
           pills.name AS pill_name,
           pt.quantity
      FROM pill_transactions pt
           JOIN
           pills ON pt.pill_id = pills.id
     ORDER BY pt.timestamp_utc DESC;

